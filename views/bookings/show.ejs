<% layout('/layouts/boilerplate') %>

<div class="row">
    <div class="col-md-8 offset-md-2">
        <!-- Success Banner -->
        <div class="alert alert-success text-center py-4 mb-4">
            <i class="fas fa-check-circle fa-3x mb-3"></i>
            <h3>Booking Confirmed!</h3>
            <p class="lead mb-0">Your service has been booked successfully</p>
        </div>
        
        <!-- Booking Details Card -->
        <div class="card shadow mb-4">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="fas fa-receipt"></i> Booking Details</h4>
            </div>
            <div class="card-body p-4">
                <!-- Booking ID -->
                <div class="text-center mb-4 p-3 bg-light rounded">
                    <h6 class="text-muted mb-2">Booking ID</h6>
                    <h3 class="text-primary mb-0"><%= booking.bookingId %></h3>
                </div>
                
                <!-- Service Info -->
                <div class="mb-4">
                    <h5 class="mb-3">Service Information</h5>
                    <div class="d-flex align-items-center bg-light p-3 rounded">
                        <% if (booking.service) { %>
                            <span style="font-size: 3rem;" class="me-3"><%= booking.service.icon %></span>
                            <div>
                                <h5 class="mb-1"><%= booking.service.name %></h5>
                                <p class="mb-0 text-muted"><%= booking.service.category %></p>
                            </div>
                        <% } else { %>
                            <span style="font-size: 3rem;" class="me-3">ðŸ”§</span>
                            <div>
                                <h5 class="mb-1">Service Unavailable</h5>
                                <p class="mb-0 text-muted">This service has been removed</p>
                            </div>
                        <% } %>
                    </div>
                </div>
                
                <!-- Schedule Info -->
                <div class="mb-4">
                    <h5 class="mb-3">Schedule</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="info-box p-3 bg-light rounded mb-3">
                                <i class="fas fa-calendar text-primary"></i>
                                <strong>Date:</strong> <%= new Date(booking.scheduledDate).toLocaleDateString('en-IN', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'}) %>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-box p-3 bg-light rounded mb-3">
                                <i class="fas fa-clock text-primary"></i>
                                <strong>Time:</strong> <%= booking.scheduledTime %>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-bolt"></i>
                        <strong>Estimated Arrival Time:</strong> <%= booking.estimatedArrivalTime %>
                        <br>
                        <small>Our service provider will arrive within 15 minutes of your scheduled time</small>
                    </div>
                </div>
                
                <!-- Service Address -->
                <div class="mb-4">
                    <h5 class="mb-3">Service Address</h5>
                    <div class="p-3 bg-light rounded">
                        <i class="fas fa-map-marker-alt text-danger"></i>
                        <%= booking.address.street %>,
                        <%= booking.address.city %>,
                        <%= booking.address.state %> - <%= booking.address.pincode %>
                    </div>
                </div>
                
                <!-- Special Instructions -->
                <% if (booking.specialInstructions) { %>
                    <div class="mb-4">
                        <h5 class="mb-3">Special Instructions</h5>
                        <div class="p-3 bg-light rounded">
                            <%= booking.specialInstructions %>
                        </div>
                    </div>
                <% } %>
                
                <!-- Status -->
                <div class="mb-4">
                    <h5 class="mb-3">Booking Status</h5>
                    <div class="text-center">
                        <% 
                            let statusClass = '';
                            let statusIcon = '';
                            switch(booking.status) {
                                case 'Confirmed':
                                    statusClass = 'success';
                                    statusIcon = 'check-circle';
                                    break;
                                case 'In Progress':
                                    statusClass = 'warning';
                                    statusIcon = 'spinner';
                                    break;
                                case 'Completed':
                                    statusClass = 'info';
                                    statusIcon = 'check-double';
                                    break;
                                case 'Cancelled':
                                    statusClass = 'danger';
                                    statusIcon = 'times-circle';
                                    break;
                                default:
                                    statusClass = 'secondary';
                                    statusIcon = 'question-circle';
                            }
                        %>
                        <span class="badge bg-<%= statusClass %> p-3" style="font-size: 1.2rem;">
                            <i class="fas fa-<%= statusIcon %>"></i> <%= booking.status %>
                        </span>
                    </div>
                </div>
                
                <!-- Payment Info -->
                <hr>
                <div class="mb-4">
                    <h5 class="mb-3">Payment Information</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="info-box p-3 bg-light rounded mb-3">
                                <i class="fas fa-credit-card text-primary"></i>
                                <strong>Payment Method:</strong> 
                                <span class="badge bg-info ms-2"><%= booking.paymentMethod || 'Cash on Service' %></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-box p-3 bg-light rounded mb-3">
                                <i class="fas fa-check-circle text-success"></i>
                                <strong>Payment Status:</strong> 
                                <% 
                                    let paymentStatusClass = '';
                                    switch(booking.paymentStatus) {
                                        case 'Paid':
                                            paymentStatusClass = 'success';
                                            break;
                                        case 'Pending':
                                            paymentStatusClass = 'warning';
                                            break;
                                        case 'Failed':
                                            paymentStatusClass = 'danger';
                                            break;
                                        case 'Refunded':
                                            paymentStatusClass = 'info';
                                            break;
                                        default:
                                            paymentStatusClass = 'secondary';
                                    }
                                %>
                                <span class="badge bg-<%= paymentStatusClass %> ms-2"><%= booking.paymentStatus || 'Pending' %></span>
                            </div>
                        </div>
                    </div>
                    
                    <% if (booking.paymentMethod === 'Online Payment' && booking.razorpayPaymentId) { %>
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i>
                            <strong>Payment Successful!</strong>
                            <br>
                            <small>Transaction ID: <%= booking.razorpayPaymentId %></small>
                        </div>
                    <% } %>
                    
                    <% if (booking.paymentStatus === 'Refunded') { %>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Refund Processed:</strong> Your payment has been refunded. It will reflect in your account within 5-7 business days.
                        </div>
                    <% } %>
                </div>
                
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Total Amount:</h5>
                    <h3 class="mb-0 text-success">â‚¹<%= booking.totalPrice %></h3>
                </div>
                
                <!-- Actions -->
                <div class="mt-4">
                    <% if (booking.status === 'Confirmed' || booking.status === 'Pending') { %>
                        <form action="/bookings/<%= booking._id %>?_method=DELETE" method="POST" class="d-inline">
                            <button type="submit" class="btn btn-danger w-100 mb-2" onclick="return confirm('Are you sure you want to cancel this booking?')">
                                <i class="fas fa-times-circle"></i> Cancel Booking
                            </button>
                        </form>
                    <% } %>
                    
                    <% if (booking.status === 'Completed' && !booking.rating) { %>
                        <button class="btn btn-warning w-100 mb-2" data-bs-toggle="modal" data-bs-target="#ratingModal">
                            <i class="fas fa-star"></i> Rate This Service
                        </button>
                    <% } %>
                    
                    <a href="/bookings/history" class="btn btn-outline-primary w-100">
                        <i class="fas fa-history"></i> View All Bookings
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Rating Modal -->
<% if (booking.status === 'Completed' && !booking.rating) { %>
<div class="modal fade" id="ratingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Rate Your Experience</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="/bookings/<%= booking._id %>/rate" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Rating</label>
                        <div class="rating-stars">
                            <input type="radio" name="rating" value="5" id="star5" required>
                            <label for="star5">â˜…</label>
                            <input type="radio" name="rating" value="4" id="star4">
                            <label for="star4">â˜…</label>
                            <input type="radio" name="rating" value="3" id="star3">
                            <label for="star3">â˜…</label>
                            <input type="radio" name="rating" value="2" id="star2">
                            <label for="star2">â˜…</label>
                            <input type="radio" name="rating" value="1" id="star1">
                            <label for="star1">â˜…</label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="review" class="form-label">Review (Optional)</label>
                        <textarea class="form-control" name="review" id="review" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Submit Rating</button>
                </div>
            </form>
        </div>
    </div>
</div>
<% } %>
